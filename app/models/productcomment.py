from flask import current_app as app

# For reference, the SQL for the Users table is as follows:
# 
# CREATE TABLE ProductComments (
#     id INT NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
#     productid INT NOT NULL REFERENCES Products(id),
#     userid INT NOT NULL REFERENCES Users(id),
#     comment VARCHAR(255),
#     time_commented timestamp without time zone NOT NULL DEFAULT (current_timestamp AT TIME ZONE 'UTC'),
#     rate INT
# );


class ProductComment:
    def __init__(self, id, productid, userid, comment, time_commented, rate):
        self.id = id
        self.productid = productid
        self.userid = userid
        self.comment = comment
        self.time_commented = time_commented
        self.rate = rate

    @staticmethod
    def get_product_comments_by_user(userid):
        sqlstr = """
        SELECT id, productid, userid, comment, time_commented, rate
        FROM ProductComments
        WHERE userid = :userid
        ORDER BY time_commented DESC
        LIMIT 5;
        """
        results = app.db.execute(sqlstr, userid=userid)
        return [ProductComment(*row) for row in results]

    @staticmethod
    def get_comment_by_id(comment_id):
        sqlstr = """
        SELECT id, productid, userid, comment, time_commented, rate
        FROM ProductComments
        WHERE id = :comment_id;
        """
        result = app.db.execute(sqlstr, comment_id=comment_id)
        if result:
            return ProductComment(*result[0])
        return None

    def update(self):
        sqlstr = """
        UPDATE ProductComments
        SET comment = :comment, rate = :rate, time_commented = current_timestamp
        WHERE id = :id;
        """
        app.db.execute(sqlstr, id=self.id, comment=self.comment, rate=self.rate)

    @staticmethod
    def insert_comment(comment, product_id, rating, user_id):
        sqlstr = """
        INSERT INTO ProductComments (productid, userid, comment, rate, time_commented) 
        VALUES (:product_id, :user_id, :comment, :rating, current_timestamp);
        """
        app.db.execute(sqlstr, product_id=product_id, user_id=user_id, comment=comment, rating=rating)

    @staticmethod
    def delete_comment(comment_id):
        sqlstr = "DELETE FROM ProductComments WHERE id = :comment_id;"
        app.db.execute(sqlstr, comment_id=comment_id)
